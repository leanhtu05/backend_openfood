{% extends "base.html" %}

{% block title %}Admin Dashboard - OpenFood Management{% endblock %}

{% block page_title %}Dashboard Tổng Quan{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-primary" onclick="refreshStats()">
        <i class="fas fa-sync-alt"></i> Làm mới
    </button>
    <button type="button" class="btn btn-outline-success" onclick="exportReport()">
        <i class="fas fa-download"></i> Xuất báo cáo
    </button>
    <button type="button" class="btn btn-outline-warning" onclick="testDownload()">
        <i class="fas fa-bug"></i> Test Download
    </button>
    <button type="button" class="btn btn-outline-info" onclick="testCSV()">
        <i class="fas fa-table"></i> Test CSV
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Tổng số món ăn</div>
                        <div class="h5 mb-0 font-weight-bold">{{ stats.total_foods or 0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-hamburger fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card-success">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Người dùng hoạt động</div>
                        <div class="h5 mb-0 font-weight-bold">{{ stats.active_users or 0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card-warning">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Kế hoạch bữa ăn</div>
                        <div class="h5 mb-0 font-weight-bold">{{ stats.total_meal_plans or 0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card-info">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">API Calls hôm nay</div>
                        <div class="h5 mb-0 font-weight-bold">{{ stats.api_calls_today or 0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-xl-8 col-lg-7">
        <div class="card">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Hoạt động hệ thống (7 ngày qua)</h6>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-5">
        <div class="card">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Loại món ăn phổ biến</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4 pb-2">
                    <canvas id="foodTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Hoạt động gần đây</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for activity in recent_activities %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">{{ activity.action }}</div>
                            <small class="text-muted">{{ activity.description }}</small>
                        </div>
                        <small class="text-muted">{{ activity.timestamp }}</small>
                    </div>
                    {% else %}
                    <div class="list-group-item text-center text-muted">
                        Chưa có hoạt động nào
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Món ăn được tạo gần đây</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for food in recent_foods %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">{{ food.name }}</div>
                            <small class="text-muted">{{ food.nutrition.calories }} kcal</small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">{{ food.created_at }}</small>
                            <br>
                            <a href="/admin/foods" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
                        </div>
                    </div>
                    {% else %}
                    <div class="list-group-item text-center text-muted">
                        Chưa có món ăn nào
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Status -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Trạng thái hệ thống</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator bg-success me-2"></div>
                            <div>
                                <div class="fw-bold">Database</div>
                                <small class="text-muted">Hoạt động bình thường</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator {% if system_status.ai_available %}bg-success{% else %}bg-warning{% endif %} me-2"></div>
                            <div>
                                <div class="fw-bold">AI Service</div>
                                <small class="text-muted">
                                    {% if system_status.ai_available %}
                                        {{ system_status.ai_type }}
                                    {% else %}
                                        Không khả dụng
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator {% if system_status.firebase_connected %}bg-success{% else %}bg-danger{% endif %} me-2"></div>
                            <div>
                                <div class="fw-bold">Firebase</div>
                                <small class="text-muted">
                                    {% if system_status.firebase_connected %}
                                        Kết nối thành công
                                    {% else %}
                                        Lỗi kết nối
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator bg-success me-2"></div>
                            <div>
                                <div class="fw-bold">API Server</div>
                                <small class="text-muted">Hoạt động bình thường</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    .chart-area {
        position: relative;
        height: 300px;
    }
    .chart-pie {
        position: relative;
        height: 250px;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- 🚀 Load Chart.js asynchronously -->
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script>
// 🚀 Wait for Chart.js to load before initializing charts
document.addEventListener('DOMContentLoaded', function() {
    // Check if Chart.js is loaded
    function initCharts() {
        if (typeof Chart === 'undefined') {
            setTimeout(initCharts, 100);
            return;
        }

        // Activity Chart
        const activityCtx = document.getElementById('activityChart').getContext('2d');
        const activityChart = new Chart(activityCtx, {
    type: 'line',
    data: {
        labels: {{ activity_chart_labels | tojson }},
        datasets: [{
            label: 'API Calls',
            data: {{ activity_chart_data | tojson }},
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Food Type Chart
const foodTypeCtx = document.getElementById('foodTypeChart').getContext('2d');
const foodTypeChart = new Chart(foodTypeCtx, {
    type: 'doughnut',
    data: {
        labels: {{ food_type_labels | tojson }},
        datasets: [{
            data: {{ food_type_data | tojson }},
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});
    }

    // Initialize charts
    initCharts();
});

// 🚀 Optimized refresh function
function refreshStats() {
    // Show loading indicator
    const statsCards = document.querySelectorAll('.stat-card, .stat-card-success, .stat-card-warning, .stat-card-info');
    statsCards.forEach(card => {
        card.style.opacity = '0.6';
        card.style.pointerEvents = 'none';
    });

    // Add loading spinner
    const loadingSpinner = document.createElement('div');
    loadingSpinner.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; background: #007bff; color: white; padding: 10px 15px; border-radius: 5px; z-index: 1000;">
            <i class="fas fa-spinner fa-spin"></i> Đang làm mới...
        </div>
    `;
    loadingSpinner.id = 'refreshSpinner';
    document.body.appendChild(loadingSpinner);

    // Reload page
    setTimeout(() => {
        location.reload();
    }, 500);
}

function exportReport() {
    // Tạo modal chọn format
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
                <h4 style="margin-top: 0; color: #333; text-align: center;">📊 Chọn định dạng xuất báo cáo</h4>
                <div style="margin: 20px 0;">
                    <button onclick="downloadReport('excel')" style="width: 100%; margin: 5px 0; padding: 12px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                        📊 Excel (.xlsx) - Khuyến nghị
                    </button>
                    <button onclick="downloadReport('word')" style="width: 100%; margin: 5px 0; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                        📄 Word (.docx) - Báo cáo đẹp
                    </button>
                    <button onclick="downloadReport('csv')" style="width: 100%; margin: 5px 0; padding: 12px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                        📋 CSV - Dữ liệu thô
                    </button>
                    <button onclick="downloadReport('json')" style="width: 100%; margin: 5px 0; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                        🔧 JSON - Lập trình viên
                    </button>
                </div>
                <button onclick="closeModal()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                    ❌ Hủy
                </button>
            </div>
        </div>
    `;
    modal.id = 'exportModal';
    document.body.appendChild(modal);
}

async function downloadReport(format) {
    // Đóng modal
    closeModal();

    // Hiển thị loading
    const loadingToast = document.createElement('div');
    loadingToast.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; background: #007bff; color: white; padding: 15px 20px; border-radius: 5px; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
            <i class="fas fa-spinner fa-spin"></i> Đang tạo báo cáo ${format.toUpperCase()}...
        </div>
    `;
    loadingToast.id = 'loadingToast';
    document.body.appendChild(loadingToast);

    try {
        // Tạo download token
        const tokenResponse = await fetch('/admin/api/create-download-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!tokenResponse.ok) {
            throw new Error('Không thể tạo token download');
        }

        const tokenData = await tokenResponse.json();
        if (!tokenData.success) {
            throw new Error('Không thể tạo token download');
        }

        // Tạo URL với token
        const now = new Date();
        const endDate = now.toISOString().split('T')[0];
        const startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        const exportUrl = `/admin/api/export/report?format=${format}&start_date=${startDate}&end_date=${endDate}&token=${tokenData.token}`;

        // Tạo link download và click tự động
        const link = document.createElement('a');
        link.href = exportUrl;

        // Xác định extension
        let extension = format;
        if (format === 'excel') extension = 'xlsx';
        if (format === 'word') extension = 'docx';

        link.download = `admin_report_${new Date().toISOString().split('T')[0]}.${extension}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Xóa loading và hiển thị success
        setTimeout(() => {
            const toast = document.getElementById('loadingToast');
            if (toast) {
                document.body.removeChild(toast);
            }

            // Hiển thị success message
            const successToast = document.createElement('div');
            successToast.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 5px; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                    <i class="fas fa-check"></i> Báo cáo ${format.toUpperCase()} đã được tải xuống!
                </div>
            `;
            document.body.appendChild(successToast);

            setTimeout(() => {
                document.body.removeChild(successToast);
            }, 3000);
        }, 2000);

    } catch (error) {
        console.error('Error downloading report:', error);

        // Xóa loading
        const toast = document.getElementById('loadingToast');
        if (toast) {
            document.body.removeChild(toast);
        }

        // Hiển thị error message
        const errorToast = document.createElement('div');
        errorToast.innerHTML = `
            <div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px 20px; border-radius: 5px; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                <i class="fas fa-exclamation-triangle"></i> Lỗi: ${error.message}
            </div>
        `;
        document.body.appendChild(errorToast);

        setTimeout(() => {
            document.body.removeChild(errorToast);
        }, 5000);
    }
}

function closeModal() {
    const modal = document.getElementById('exportModal');
    if (modal) {
        document.body.removeChild(modal);
    }
}

function testDownload() {
    // Test download đơn giản
    const link = document.createElement('a');
    link.href = '/admin/api/test-download';
    link.download = `test_report_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Hiển thị thông báo
    const toast = document.createElement('div');
    toast.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; background: #ffc107; color: black; padding: 15px 20px; border-radius: 5px; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
            <i class="fas fa-bug"></i> Test download started...
        </div>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        document.body.removeChild(toast);
    }, 3000);
}

function testCSV() {
    // Test CSV download
    const link = document.createElement('a');
    link.href = '/admin/api/test-csv';
    link.download = `test_csv_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Hiển thị thông báo
    const toast = document.createElement('div');
    toast.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; background: #17a2b8; color: white; padding: 15px 20px; border-radius: 5px; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
            <i class="fas fa-table"></i> Test CSV download started...
        </div>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        document.body.removeChild(toast);
    }, 3000);
}
</script>
{% endblock %}
